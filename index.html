<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ConvMatrix | Universal CNN Architect</title>
    <meta name="description" content="A professional CNN layer calculator to solve for Input, Output, or Convolution parameters. Designed for Deep Learning researchers.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top left, #f8fafc, #e2e8f0);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.4);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px -10px rgba(0, 0, 0, 0.1);
        }
        .param-slider {
            -webkit-appearance: none;
            height: 6px;
            background: #cbd5e1;
            border-radius: 10px;
        }
        .param-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .color-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .badge {
            font-family: monospace;
            padding: 2px 6px;
            background: #f1f5f9;
            border-radius: 4px;
            font-weight: 700;
        }
    </style>
</head>
<body class="min-h-screen py-12 px-4">
    <div class="max-w-5xl mx-auto">
        <header class="text-center mb-12">
            <h1 class="text-5xl font-extrabold text-slate-900 tracking-tight mb-3">
                Conv<span class="text-blue-600">Matrix</span>
            </h1>
            <p class="text-slate-500 text-lg">Universal Convolutional Neural Network Architect</p>
        </header>

        <div class="grid grid-cols-1 gap-10">
            
            <section class="glass-card rounded-3xl p-8">
                <div class="flex items-center justify-between mb-8 border-b border-slate-200 pb-4">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center">
                        <span class="bg-blue-600 text-white w-8 h-8 rounded-lg flex items-center justify-center mr-3 text-sm">01</span>
                        Forward Calculation (Input → Output)
                    </h2>
                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-widest">Standard Mode</span>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label class="text-sm font-semibold text-slate-600 block mb-3">Input Size <span class="badge text-red-500">W1/H1</span></label>
                                <input type="range" id="w1" min="1" max="512" value="128" class="param-slider w-full">
                                <div class="flex justify-between mt-2 text-xs font-bold text-slate-400"><span>1</span><span id="w1-value">128</span><span>512</span></div>
                            </div>
                            <div>
                                <label class="text-sm font-semibold text-slate-600 block mb-3">Filter Count <span class="badge text-orange-500">K</span></label>
                                <input type="range" id="k" min="1" max="512" value="64" class="param-slider w-full">
                                <div class="flex justify-between mt-2 text-xs font-bold text-slate-400"><span>1</span><span id="k-value">64</span><span>512</span></div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 bg-slate-50 p-4 rounded-2xl">
                            <div>
                                <label class="text-xs font-bold text-slate-400 block mb-2">Kernel (F)</label>
                                <input type="number" id="f" value="3" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 block mb-2">Stride (S)</label>
                                <input type="number" id="s" value="1" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-400 block mb-2">Padding (P)</label>
                                <input type="number" id="p" value="1" class="w-full bg-white border border-slate-200 rounded-lg p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col justify-center items-center bg-slate-900 rounded-3xl p-8 text-white shadow-2xl">
                        <div class="text-slate-400 text-xs font-bold uppercase mb-6 tracking-widest">Calculated Feature Map</div>
                        <div class="flex items-center gap-4">
                            <div class="text-center">
                                <div class="text-4xl font-light" id="output-w-display">128</div>
                                <div class="text-[10px] text-slate-500 mt-1">WIDTH</div>
                            </div>
                            <div class="text-slate-700 text-2xl">×</div>
                            <div class="text-center">
                                <div class="text-4xl font-light" id="output-h-display">128</div>
                                <div class="text-[10px] text-slate-500 mt-1">HEIGHT</div>
                            </div>
                            <div class="text-slate-700 text-2xl">×</div>
                            <div class="text-center">
                                <div class="text-4xl font-bold text-blue-400" id="output-d-display">64</div>
                                <div class="text-[10px] text-blue-400/50 mt-1">CHANNELS</div>
                            </div>
                        </div>
                        <div id="error-output" class="mt-6 text-red-400 text-xs font-medium"></div>
                    </div>
                </div>
            </section>

            <section class="glass-card rounded-3xl p-8">
                <div class="flex items-center justify-between mb-8 border-b border-slate-200 pb-4">
                    <h2 class="text-xl font-bold text-slate-800 flex items-center">
                        <span class="bg-purple-600 text-white w-8 h-8 rounded-lg flex items-center justify-center mr-3 text-sm">02</span>
                        Architect Solver (Input + Output → Params)
                    </h2>
                    <span class="text-xs font-semibold text-slate-400 uppercase tracking-widest">Reverse Engineering</span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
                    <div class="space-y-4">
                        <h4 class="text-sm font-bold text-slate-400 uppercase">Target Input</h4>
                        <input type="number" id="w1-2" placeholder="Input W" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 outline-none focus:bg-white focus:ring-2 focus:ring-purple-500 transition-all">
                    </div>
                    <div class="space-y-4">
                        <h4 class="text-sm font-bold text-slate-400 uppercase">Target Output</h4>
                        <input type="number" id="w2" placeholder="Output W" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-4 outline-none focus:bg-white focus:ring-2 focus:ring-purple-500 transition-all">
                    </div>
                </div>


                <div class="mt-6 space-y-3">
                    <div class="flex bg-slate-100 rounded-2xl p-1">
                        <button id="mode-conv" data-mode="conv" class="mode-btn flex-1 py-3 rounded-2xl text-sm font-bold transition-all bg-slate-900 text-white">
                            Conv2d (downsample)
                        </button>
                        <button id="mode-deconv" data-mode="deconv" class="mode-btn flex-1 py-3 rounded-2xl text-sm font-bold transition-all text-slate-700 hover:text-slate-900">
                            ConvTranspose2d (upsample)
                        </button>
                    </div>
                    <div class="flex items-center justify-between">
                        <label class="flex items-center gap-2 text-sm text-slate-600 select-none">
                            <input id="advanced-search" type="checkbox" class="w-4 h-4 accent-purple-600">
                            Advanced search (wider ranges)
                        </label>
                        <span id="mode-hint" class="text-xs text-slate-400"></span>
                    </div>
                </div>

                <button id="calc-conv-btn" class="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl hover:bg-purple-600 transition-colors shadow-lg shadow-purple-200">
                    Solve Parameters
                </button>

                <div id="conv-result-container" class="hidden mt-8 space-y-4">
                    <h4 class="text-xs font-bold text-slate-400 uppercase tracking-widest px-2">Top Recommended Configurations</h4>
                    <div id="solutions-list" class="grid grid-cols-1 gap-3">
                    </div>
                </div>
                
                <div id="error-conv" class="text-center mt-4 text-red-500 font-medium"></div>
            </section>
        </div>

        <footer class="mt-16 text-center text-slate-400 text-sm">
            <p>&copy; 2026 ConvMatrix | Designed for Visual Computing Researchers</p>
        </footer>
    </div>

    <script>
        // Forward calculation update function
        const updateForward = () => {
            const w1 = parseInt(document.getElementById('w1').value);
            const f = parseInt(document.getElementById('f').value);
            const s = parseInt(document.getElementById('s').value);
            const p = parseInt(document.getElementById('p').value);
            const k = parseInt(document.getElementById('k').value);

            document.getElementById('w1-value').textContent = w1;
            document.getElementById('k-value').textContent = k;

            const w2 = Math.floor((w1 - f + 2 * p) / s) + 1;
            
            if (w2 <= 0) {
                document.getElementById('error-output').textContent = "Invalid Configuration";
            } else {
                document.getElementById('error-output').textContent = "";
                document.getElementById('output-w-display').textContent = w2;
                document.getElementById('output-h-display').textContent = w2;
                document.getElementById('output-d-display').textContent = k;
            }
        };

        // Bind events for forward calculation
        ['w1', 'f', 's', 'p', 'k'].forEach(id => {
            document.getElementById(id).addEventListener('input', updateForward);
        });

        // Solver logic with optimized scoring system
        document.getElementById('calc-conv-btn').addEventListener('click', () => {
            const w_in = parseInt(document.getElementById('w1-2').value);
            const w_out = parseInt(document.getElementById('w2').value);
            const listContainer = document.getElementById('conv-result-container');
            const listBody = document.getElementById('solutions-list');
            const errDiv = document.getElementById('error-conv');

            const mode = window.__solverMode || 'conv'; // 'conv' | 'deconv'
            const advanced = !!document.getElementById('advanced-search')?.checked;

            const isPosInt = (x) => Number.isInteger(x) && x > 0;

            if (!isPosInt(w_in) || !isPosInt(w_out)) {
                listContainer.classList.add('hidden');
                errDiv.textContent = "Please enter valid positive integers for both input and output.";
                return;
            }

            // ---- Forward formulas (1D, dilation=1) ----
            const convOut = (win, k, s, p) => Math.floor((win + 2 * p - k) / s) + 1;
            const deconvOut = (win, k, s, p, op) => (win - 1) * s - 2 * p + k + op;

            // ---- Common candidate sets (fast + covers typical CNN design) ----
            const commonStrides = [1, 2, 3, 4];
            const commonKernels = [1, 2, 3, 4, 5, 7, 9, 11];

            const makeCommonPaddings = (k) => {
                const pSame = Math.floor((k - 1) / 2);
                const cand = [0, pSame, pSame - 1, pSame + 1].filter(v => v >= 0);
                // unique
                return [...new Set(cand)];
            };

            // ---- Advanced ranges (broader, still bounded to avoid runaway) ----
            const sMax = advanced ? Math.min(8, Math.ceil(w_in / Math.max(1, w_out)) + 4) : 4;
            const kMax = advanced ? 15 : 11;

            // padding upper bound: generous but safe (covers odd cases like "same" with large kernels)
            const pMax = advanced ? Math.max(32, w_in) : 0; // not used in common-only path

            let solutions = [];

            const pushSolution = (sol) => {
                // --- Scoring: prefer common, small padding, small stride, small kernel ---
                let score = 0;

                // Padding preference: same padding and 0 are most common
                const pSame = Math.floor((sol.k - 1) / 2);
                if (sol.p === pSame) score += 0;
                else if (sol.p === 0) score += 3;
                else score += 10 + sol.p * 2;

                // Stride preference
                if (sol.s === 1) score += 0;
                else if (sol.s === 2) score += 5;
                else score += 15 + (sol.s - 3) * 5;

                // Kernel preference
                if (sol.k === 3) score += 0;
                else if (sol.k === 4) score += 2;
                else if (sol.k === 5) score += 4;
                else if (sol.k === 1) score += 6;
                else score += 12;

                // Deconv: prefer output_padding=0
                if (mode === 'deconv') score += (sol.op || 0) * 8;

                // Slightly prefer exact / clean arithmetic cases (optional tie-break)
                score += sol.k * 0.01;

                sol.score = score;
                solutions.push(sol);
            };

            // ---- Solve ----
            const searchConvCommon = () => {
                for (const s of commonStrides) {
                    for (const k of commonKernels) {
                        for (const p of makeCommonPaddings(k)) {
                            const out = convOut(w_in, k, s, p);
                            if (out === w_out && out > 0) pushSolution({ k, s, p });
                        }
                    }
                }
            };

            const searchConvAdvanced = () => {
                for (let s = 1; s <= sMax; s++) {
                    for (let k = 1; k <= kMax; k++) {
                        // try common paddings first
                        for (const p of makeCommonPaddings(k)) {
                            const out = convOut(w_in, k, s, p);
                            if (out === w_out && out > 0) pushSolution({ k, s, p });
                        }
                        // then broaden padding sweep
                        for (let p = 0; p <= pMax; p++) {
                            const out = convOut(w_in, k, s, p);
                            if (out === w_out && out > 0) pushSolution({ k, s, p });
                        }
                    }
                }
            };

            const searchDeconvCommon = () => {
                for (const s of commonStrides) {
                    for (const k of commonKernels) {
                        for (const p of makeCommonPaddings(k)) {
                            const op = 0;
                            const out = deconvOut(w_in, k, s, p, op);
                            if (out === w_out && out > 0) pushSolution({ k, s, p, op });
                        }
                    }
                }
            };

            const searchDeconvAdvanced = () => {
                for (let s = 1; s <= sMax; s++) {
                    for (let k = 1; k <= kMax; k++) {
                        // first common paddings
                        for (const p of makeCommonPaddings(k)) {
                            for (let op = 0; op <= Math.max(0, s - 1); op++) {
                                const out = deconvOut(w_in, k, s, p, op);
                                if (out === w_out && out > 0) pushSolution({ k, s, p, op });
                            }
                        }
                        // then broaden padding sweep
                        for (let p = 0; p <= pMax; p++) {
                            for (let op = 0; op <= Math.max(0, s - 1); op++) {
                                const out = deconvOut(w_in, k, s, p, op);
                                if (out === w_out && out > 0) pushSolution({ k, s, p, op });
                            }
                        }
                    }
                }
            };

            if (mode === 'conv') {
                searchConvCommon();
                if (advanced) searchConvAdvanced();
            } else {
                searchDeconvCommon();
                if (advanced) searchDeconvAdvanced();
            }

            // Deduplicate (same k,s,p,op)
            const keyOf = (sol) => `${sol.k}|${sol.s}|${sol.p}|${sol.op ?? 0}`;
            const uniq = new Map();
            for (const sol of solutions) {
                const key = keyOf(sol);
                if (!uniq.has(key) || sol.score < uniq.get(key).score) uniq.set(key, sol);
            }
            solutions = Array.from(uniq.values());

            listBody.innerHTML = '';

            if (solutions.length > 0) {
                solutions.sort((a, b) => a.score - b.score);
                const top = solutions.slice(0, 5);

                // Update header text to match mode
                const header = listContainer.querySelector('h4');
                if (header) header.textContent = mode === 'conv'
                    ? 'Top Recommended Conv2d Configurations'
                    : 'Top Recommended ConvTranspose2d Configurations';

                top.forEach((sol, index) => {
                    const isBest = index === 0;
                    const card = document.createElement('div');

                    const hasOp = mode === 'deconv';
                    const gridCols = hasOp ? 'grid-cols-4' : 'grid-cols-3';

                    card.className = `flex items-center justify-between p-4 rounded-2xl border-2 transition-all ${
                        isBest ? 'border-purple-500 bg-purple-50/50' : 'border-slate-100 bg-white'
                    }`;

                    const opBlock = hasOp ? `
                        <div>
                          <span class="block text-[10px] text-slate-400 font-bold uppercase">OutPad</span>
                          <span class="font-bold text-slate-800">OP=${sol.op ?? 0}</span>
                        </div>` : '';

                    card.innerHTML = `
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-bold ${isBest ? 'text-purple-600' : 'text-slate-400'}">${isBest ? 'BEST' : '#' + (index + 1)}</span>
                            <div class="grid ${gridCols} gap-6">
                                <div>
                                    <span class="block text-[10px] text-slate-400 font-bold uppercase">Kernel</span>
                                    <span class="font-bold text-slate-800">K=${sol.k}</span>
                                </div>
                                <div>
                                    <span class="block text-[10px] text-slate-400 font-bold uppercase">Stride</span>
                                    <span class="font-bold text-slate-800">S=${sol.s}</span>
                                </div>
                                <div>
                                    <span class="block text-[10px] text-purple-600 font-bold uppercase">Padding</span>
                                    <span class="font-bold text-purple-600">P=${sol.p}</span>
                                </div>
                                ${opBlock}
                            </div>
                        </div>
                        ${isBest ? '<span class="text-purple-600 text-xs font-bold">Recommended</span>' : ''}
                    `;
                    listBody.appendChild(card);
                });

                listContainer.classList.remove('hidden');
                errDiv.textContent = "";
            } else {
                listContainer.classList.add('hidden');
                const modeText = mode === 'conv' ? 'Conv2d' : 'ConvTranspose2d';
                errDiv.textContent = advanced
                    ? `No integer (K,S,P${mode === 'deconv' ? ',OP' : ''}) solution found for ${modeText} under current search bounds.`
                    : `No common solution found for ${modeText}. Try enabling "Advanced search".`;
            }
        });

        // Initialize
        updateForward();
    
        // ----- Solver mode toggle (Conv2d vs ConvTranspose2d) -----
        window.__solverMode = 'conv';
        const setSolverMode = (mode) => {
            window.__solverMode = mode;
            const convBtn = document.getElementById('mode-conv');
            const deconvBtn = document.getElementById('mode-deconv');
            const hint = document.getElementById('mode-hint');

            if (convBtn && deconvBtn) {
                if (mode === 'conv') {
                    convBtn.className = "mode-btn flex-1 py-3 rounded-2xl text-sm font-bold transition-all bg-slate-900 text-white";
                    deconvBtn.className = "mode-btn flex-1 py-3 rounded-2xl text-sm font-bold transition-all text-slate-700 hover:text-slate-900";
                    if (hint) hint.textContent = "Downsample / keep size (standard Conv2d)";
                } else {
                    convBtn.className = "mode-btn flex-1 py-3 rounded-2xl text-sm font-bold transition-all text-slate-700 hover:text-slate-900";
                    deconvBtn.className = "mode-btn flex-1 py-3 rounded-2xl text-sm font-bold transition-all bg-slate-900 text-white";
                    if (hint) hint.textContent = "Upsample (ConvTranspose2d / decoder / GAN)";
                }
            }
        };

        document.getElementById('mode-conv')?.addEventListener('click', () => setSolverMode('conv'));
        document.getElementById('mode-deconv')?.addEventListener('click', () => setSolverMode('deconv'));
        setSolverMode('conv');

</script>
</body>
</html>
